\newif\ifslides
\ifnotes\else\slidestrue\fi

%
% page geometry, layout and numbering
%

\definepapersize[A7w][width=65mm,height=97.5mm]
\ifnotes  \setuppapersize[A4][A4] \fi
\ifslides \setuppapersize[A7w,landscape][A7w,landscape] \fi

\setuplayout [width=middle, height=middle, grid=no, header=0cm]
\ifnotes  \setuplayout [backspace=.75cm, topspace=.9cm, bottomspace=.30cm, footer=.8cm] \fi
\ifslides \setuplayout [backspace=.35cm, topspace=.0cm, bottomspace=.10cm, footer=.2cm] \fi

\definemakeup [slide] [pagestate=start, top=\vfill, bottom=\vfill,
                       headerstate=start, footerstate=start, page=yes]
\definemakeup [titleslide] [pagestate=start, headerstate=stop, footerstate=start, page=yes]

\ifnotes % embedded slides
  \definecounter[slidenum][]
  \defineoverlay[slideover]
    [{\framed[width=\overlaywidth,height=\overlayheight,align={top,flushright},frame=no,roffset=2pt]
            {\footfont\rawcountervalue[slidenum]}}]
  \def\startslide{\blank[6pt]\incrementcounter[slidenum]
                  \startframed[align=width, width=96mm, frame=off, background={color,slideover},
                               backgroundcolor=gray, offset=6pt]}
  \def\stopslide{\stopframed\blank[4pt]}
\else
  \def\startslide{\startmakeup[slide]}
  \def\stopslide{\stopmakeup}
\fi

\definemixedcolumns [sectioncolumns] [n=2, balance=yes, distance=24pt, separator=rule,
                                      rulethickness=.5pt, rulecolor=gray]
\setcounter         [userpage] [1]
\setupfooter        [state=start]
\setuppagenumbering [state=start]
\setuptolerance     [verytolerant, stretch]

\input{prelude-typescript.tex}
\definefontfeature[default][default][protrusion=quality,expansion=quality]
\setupalign[hz,hanging]
\setupbodyfont[aleo]

%
% slide setup
%

\definecolor[blackcoffee] [r=0.1, g=.04, b=.02]
\definecolor[coffee]      [r=0.7, g=.29, b=.15]
\definecolor[dark]        [r=0.27, g=0.27, b=0.27]
\definecolor[lightcoffee] [r=0.98, g=.406, b=.21]
\definecolor[brownish]    [r=0.6, g=.3, b=.1]
\definecolor[midgreen]    [r=0.2, g=.8, b=.2]

%
% emphasis and colours
%

\ifnotes  \def\emcolor{\darkred} \fi
\ifslides \def\emcolor{\orange} \fi
\def\bf{\red}
\def\em{\emcolor}
\ifslides \def\code{\midgreen\tt} \else \def\code{\darkgreen\tt} \fi
\setuptype[color=midgreen]

\ifslides \startcolor[white] \fi % set the foreground (text) colour
\ifslides \setupbackgrounds[page] [background=color, backgroundcolor=black] \fi

%
% source code syntax highlighting
%

\unprotect
\ifslides
\definestartstop[SynSnippetKeyword]  [\c!color=orange,\c!style=boldface]
\definestartstop[SynSnippetOperator] [\c!color=yellow]
\definestartstop[SynSnippetBoundary] [\c!color=cyan,\c!style=boldface]
\definestartstop[SynSnippet]         [DefaultSnippet]
\definestartstop[SynSnippetName]     [\c!color=,before={\it}]
\definestartstop[SynSnippetType]     [\c!color=yellow]
\definestartstop[SynSnippetMagic]    [\c!color=magenta]
\definestartstop[SynSnippetQuote]    [\c!color=midgreen]
\definestartstop[SynSnippetString]   [\c!color=midgreen]
\definestartstop[SynSnippetComment]  [\c!color=brownish]
\else
\definestartstop[SynSnippetKeyword]  [\c!color=darkred,\c!style=boldface]
\definestartstop[SynSnippetOperator] [\c!color=darkyellow]
\definestartstop[SynSnippetBoundary] [\c!color=darkcyan,\c!style=boldface]
\definestartstop[SynSnippet]         [DefaultSnippet]
\definestartstop[SynSnippetName]     [\c!color=,before={\it}]
\definestartstop[SynSnippetType]     [\c!color=darkyellow]
\definestartstop[SynSnippetMagic]    [\c!color=darkmagenta]
\definestartstop[SynSnippetQuote]    [\c!color=darkgreen]
\definestartstop[SynSnippetString]   [\c!color=darkgreen]
\definestartstop[SynSnippetComment]  [\c!color=brownish]
\fi
\protect

\registerctxluafile{syn-cxx.lua}    {1.001}
\registerctxluafile{syn-python.lua} {1.001}
\registerctxluafile{syn-llvm.lua}   {1.001}
\registerctxluafile{syn-shell}      {1.001}

\setuptyping[before={\switchtobodyfont[\codesize]\blank[8pt]}, after={\blank[8pt]}]

%
% helper macros
%

\let\center\raggedcenter
\define[1]\d{{\mathrm d}#1} % differential

%
% named font sizes
%

\def\titlesize{18pt}
\def\sectionsize{14.5pt} % only for notes
\def\subsectionsize{13pt}
\def\bodysize{10pt}
\def\listsize{9.6pt}
\def\codesize{9.4pt}
\def\notesize{8.6pt}
\def\footsize{6.4pt}

%
% sectioning
%

\setuphead[section]       [align=center, sectionnumber=yes, placehead=yes, page=no,
                           aftersection={}, sectionstarter=PartÂ , sectionstopper=:, number=yes]
\setuphead[subsection]    [before={}, after={}, aftersection={}]
\setuphead[subsubsection] [before={}, after={}, aftersection={}, sectionstarter={}, sectionstopper={}]

\ifslides
  \setuphead[section, subsection] [before={\startmakeup[titleslide]}, after={\stopmakeup}]
\else
  \setuphead[section]    [style={\switchtobodyfont[\sectionsize]}]
  \setuphead[subsection] [style={\switchtobodyfont[\subsectionsize]}]
\fi

%
% set up spacing in various objects
%

\setupitemize  [before={\blank[4pt]\switchtobodyfont[\listsize]},
                after={\blank[2pt]}, width=16pt]
\setuptables   [distance=small, rulethickness=.4mm]
\setuptabulate [distance=small, bodyfont=\notesize]
\setupnarrower [middle=3mm]

%
% metapost graphics
%

\startMPinclusions[+]
input roundrect;

color fg;
fg := black;
\stopMPinclusions

\ifslides \startMPinclusions[+] fg := white \stopMPinclusions
          \setupMPinstance[metafun][textcolor=white] \fi

\startMPenvironment\setupbodyfont[sans,\notesize]\stopMPenvironment

%
% title (top of first page if notes, a separate slide for slides)
%

\starttext

\def\footfont{\switchtobodyfont[sans, \footsize]}
\def\foottext{\rlap{\mmtitle}\hfill\pagenumber/\lastpagenumber\hfill\llap{\currentdate}}

\ifslides
  \setupfootertexts [{\footfont\color[white]{\hfill\currentdate}}]
  \startmakeup[titleslide]
  \blank[24pt, force]
\fi

\startalignment[center]
\switchtobodyfont[\titlesize]      \mmtitle   \ifslides \blank[medium] \else \blank[small] \fi
\switchtobodyfont[\subsectionsize] \mmauthors \ifslides \blank[big] \fi
\stopalignment

\ifslides
  \stopmakeup
  \setupfootertexts [{\footfont\color[white]{\foottext}}]
\else
  \setupfootertexts [{\footfont{\foottext}}]
\fi

\switchtobodyfont[\notesize]
